language: csharp
sudo: required
node_js: 
  - "7"
python:
  - "2.7"
services:
  - docker

jobs: 
  include: 
    - stage: before install 
      script: 
      - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
      - echo "TRAVIS_BRANCH=$TRAVIS_BRANCH, PR=$TRAVIS_PULL_REQUEST, BRANCH=$BRANCH"
      - echo "$TRAVIS_COMMIT"
#      script: travis_retry pip install --upgrade pip
    - stage: install
      script: 
      - cd $TRAVIS_BUILD_DIR/SmarterBalanced.SampleItems/src/SmarterBalanced.SampleItems.Web
      - travis_retry npm install 
    - script: 
      - cd $TRAVIS_BUILD_DIR/SmarterBalanced.SampleItems
      - travis_retry dotnet restore
#    - script: travis_retry pip install ecs-deploy
#    - script: travis_retry pip install --user awscli
    - script: 
      - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
      - echo "TRAVIS_BRANCH=$TRAVIS_BRANCH, PR=$TRAVIS_PULL_REQUEST, BRANCH=$BRANCH"
      - echo "$TRAVIS_COMMIT"
      - export BUILD_NUMBER=$(echo $TRAVIS_BUILD_ID)
      - echo $BUILD_NUMBER
    - stage: build
      script: 
      - cd $TRAVIS_BUILD_DIR/SmarterBalanced.SampleItems/src/SmarterBalanced.SampleItems.Web
      - dotnet build
    - script: 
      - cd $TRAVIS_BUILD_DIR/SmarterBalanced.SampleItems/src/SmarterBalanced.SampleItems.Web
      - grunt all
    - stage: test and publish
      script: 
      - cd $TRAVIS_BUILD_DIR/SmarterBalanced.SampleItems/src/SmarterBalanced.SampleItems.Test
      - dotnet test
    - script: 
      - dotnet publish $TRAVIS_BUILD_DIR/SmarterBalanced.SampleItems/src/SmarterBalanced.SampleItems.Web -o $TRAVIS_BUILD_DIR/publish/
    - stage: before deploy
      script: 
      - cd $TRAVIS_BUILD_DIR
      - docker --version
      - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
    - stage: deploy setup
      script: chmod ugo+x DeployScripts/code_docker_deploy.sh
    - script: chmod ugo+x DeployScripts/nuget_deploy.sh
    - script: chmod ugo+x DeployScripts/app_docker_deploy.sh
    - script: chmod ugo+x DeployScripts/ecs_deploy.sh
    - stage: deploy 
      script: skip
      deploy:
        - provider: script
          skip_cleanup: true
          script: ./DeployScripts/app_docker_deploy.sh && ./DeployScripts/code_docker_deploy.sh && ./DeployScripts/nuget_deploy.sh
          on:
              tags: true
        - provider: script
          skip_cleanup: true
          script: ./DeployScripts/app_docker_deploy.sh
          on:
            branch: master
        - provider: script
          skip_cleanup: true
          script: ./DeployScripts/app_docker_deploy.sh && ./DeployScripts/nuget_deploy.sh "alpha-$BUILD_NUMBER"
          on:
            branch: dev
        - provider: script
          skip_cleanup: true
          script: ./DeployScripts/nuget_deploy.sh "alpha-$BUILD_NUMBER"
          on:
            branch: feat/travis-nuget
matrix:
  include:
  - os: linux
    dist: trusty
    sudo: required
    dotnet: 1.0.4
    mono: none
